x-superset-image: &superset-image superset-custom:latest
x-superset-volumes: &superset-volumes
  - ./superset/docker:/app/docker
  - superset_home:/app/superset_home

networks:
  internal:
    driver: bridge
  public:
    driver: bridge
  default:
    name: superset_network

services:

  # Frontend (React)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL}
    command: sh -c "npm run devmode -- --host 0.0.0.0"
    container_name: enlaight_frontend
    restart: always
    ports:
      - "8080:8080"
    networks:
      - public
    environment:
      - CHOKIDAR_USEPOLLING=true
      - CHOKIDAR_INTERVAL=300

  # Backend (Django)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: enlaight-service
    container_name: enlaight_backend
    working_dir: /src
    command: ["sh", "/scripts/run.sh"]
    restart: always
    depends_on:
      mysql:
        condition: service_healthy
    ports:
      - "8000:8000"
    env_file:
      - ./backend/.env
    environment:
      SECRET_KEY: ${SECRET_KEY}
      REACT_URL: ${REACT_URL}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_HOST: ${MYSQL_HOST}
      MYSQL_PORT: ${MYSQL_PORT}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS}
      N8N_BASE_URL: ${N8N_BASE_URL}
      N8N_KB_KEY: ${N8N_KB_KEY}
      N8N_TIMEOUT: ${N8N_TIMEOUT}
      # Set to False in .env for local development -> HTTP - PROD must be True -> HTTPS
      USE_X_FORWARDED_HOST: ${USE_X_FORWARDED_HOST}
      SECURE_SSL_REDIRECT: ${SECURE_SSL_REDIRECT}
      CSRF_COOKIE_SECURE: ${CSRF_COOKIE_SECURE}
      SESSION_COOKIE_SECURE: ${SESSION_COOKIE_SECURE}
      DEBUG: ${DEBUG}
    volumes:
      - ./backend/src:/src
      - ./backend/tests:/tests
      - ./backend/scripts:/scripts
    networks:
      - internal
      - public

  # Email service
  smtp:
    image: rnwood/smtp4dev
    container_name: smtp4dev
    restart: unless-stopped
    ports:
      - "3000:80"
      - "2525:25"
    networks:
      - internal
      - public
  
  # Databases
  mysql:
    image: mysql:8.4
    container_name: enlaight_mysql
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --log-bin-trust-function-creators=1
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      TZ: America/Sao_Paulo
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./backend/scripts:/scripts
      - ./backend/mysql/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s
    networks:
      - internal
  
  redis:
    image: redis:7-alpine
    container_name: enlaight_cache
    restart: unless-stopped
    volumes:
      - redis:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  postgres:
    image: postgres:15
    container_name: postgres_dev
    restart: unless-stopped
    environment:
      POSTGRES_DB: n8n
      POSTGRES_USER: n8n
      POSTGRES_PASSWORD: n8n_dev_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U n8n"]
      interval: 5s
      timeout: 5s
      retries: 5

  # N8N
  n8n:
    image: docker.n8n.io/n8nio/n8n:1.113.0
    container_name: n8n_dev
    restart: always
    ports:
      - "5678:5678"
    environment:
      # Core
      - NODE_ENV=development
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://localhost:5678
      - GENERIC_TIMEZONE=UTC

      # Auth / dev convenience
      - N8N_BASIC_AUTH_ACTIVE=false
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_PERSONALIZATION_ENABLED=false

      # Database (LOCAL ONLY)
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n_enlaight_db
      - DB_POSTGRESDB_USER=n8n
      - DB_POSTGRESDB_PASSWORD=n8n_dev_password
      - DB_POSTGRESDB_SSL_ENABLED=false

      - N8N_RUN_MIGRATIONS=true
    volumes:
      - n8n_data:/home/node/.n8n
      - ./n8n/local-files:/files
    networks:
      - internal
      - public
    labels:
      - traefik.enable=true
      - traefik.http.routers.n8n.rule=Host(`n8n.localhost`)
      - traefik.http.routers.n8n.entrypoints=websecure
      - traefik.http.routers.n8n.tls=true
      - traefik.http.routers.n8n.tls.certresolver=mytlschallenge
      - traefik.http.services.n8n.loadbalancer.server.port=5678
      - traefik.http.middlewares.n8n.headers.SSLRedirect=true
      - traefik.http.middlewares.n8n.headers.STSSeconds=315360000
      - traefik.http.middlewares.n8n.headers.browserXSSFilter=true
      - traefik.http.middlewares.n8n.headers.contentTypeNosniff=true
      - traefik.http.middlewares.n8n.headers.forceSTSHeader=true
      - traefik.http.middlewares.n8n.headers.SSLHost=${N8N_SSL_HOST}
      - traefik.http.middlewares.n8n.headers.STSIncludeSubdomains=true
      - traefik.http.middlewares.n8n.headers.STSPreload=true
      - traefik.http.routers.n8n.middlewares=n8n@docker
  
  traefik:
    image: traefik:v3.0
    container_name: traefik_dev
    restart: unless-stopped
    command:
      - "--api.dashboard=true"
      - "--api.insecure=false"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
    ports:
      - "80:80"
      - "443:443"
      - "8081:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - public
      - internal
  
  # Superset
  superset:
    build:
      context: ./superset
      dockerfile: Dockerfile
    image: *superset-image
    container_name: superset_app
    command: ["/app/docker/docker-bootstrap.sh", "app-gunicorn"]
    user: "root"
    restart: unless-stopped
    ports:
      - "8088:8088"
    env_file:
      - .env
    depends_on:
      superset-init:
        condition: service_completed_successfully
    volumes: *superset-volumes
    environment:
      # Production environment settings
      FLASK_ENV: production
      SUPERSET_ENV: production
      SUPERSET_LOAD_EXAMPLES: "false"
      # Enable Playwright for reports and thumbnails
      PLAYWRIGHT_REPORTS_AND_THUMBNAILS: "true"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - internal

  superset-init:
    image: *superset-image
    container_name: superset_init
    command: ["/app/docker/docker-init.sh"]
    user: "root"
    env_file:
      - .env
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started
    volumes: *superset-volumes
    environment:
      FLASK_ENV: production
      SUPERSET_ENV: production
      SUPERSET_LOAD_EXAMPLES: "false"
    healthcheck:
      disable: true
    networks:
      - internal

  superset-worker:
    image: *superset-image
    container_name: superset_worker
    command: ["/app/docker/docker-bootstrap.sh", "worker"]
    user: "root"
    env_file:
      - .env
    restart: unless-stopped
    depends_on:
      superset-init:
        condition: service_completed_successfully
    volumes: *superset-volumes
    environment:
      FLASK_ENV: production
      SUPERSET_ENV: production
    healthcheck:
      test: ["CMD-SHELL", "celery -A superset.tasks.celery_app:app inspect ping -d celery@$$HOSTNAME"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - internal

  superset-worker-beat:
    image: *superset-image
    container_name: superset_worker_beat
    command: ["/app/docker/docker-bootstrap.sh", "beat"]
    user: "root"
    env_file:
      - .env
    restart: unless-stopped
    depends_on:
      superset-init:
        condition: service_completed_successfully
    volumes: *superset-volumes
    environment:
      FLASK_ENV: production
      SUPERSET_ENV: production
    healthcheck:
      disable: true
    networks:
      - internal

volumes:
  mysql_data:
  postgres_data:
  n8n_data:
  superset_home:
    external: false
  redis:
    external: false
